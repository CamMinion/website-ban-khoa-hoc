
@*     For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860 *@

@* @{ *@
@* } *@
@* @model QL_KhoaHoc.Models.HocVien *@
@* @{ *@
@*     ViewData["Title"] = "Hồ sơ cá nhân"; *@
@*     Layout = "~/Views/Shared/_HocVien_Layout.cshtml"; *@
@* } *@

@* <div class="container py-5"> *@
@*     <div class="row"> *@
@*         <div class="col-lg-4 mb-4"> *@
@*             <div class="card border-0 shadow-sm rounded-3 overflow-hidden"> *@
@*                 <div class="card-body text-center bg-white p-4"> *@
@*                     <div class="position-relative d-inline-block mb-3"> *@
@*                         <img src="@(string.IsNullOrEmpty(Model.AnhDaiDien) ? "https://via.placeholder.com/150" : Model.AnhDaiDien)" *@
@*                              alt="Avatar" *@
@*                              class="rounded-circle img-thumbnail shadow-sm" *@
@*                              style="width: 140px; height: 140px; object-fit: cover;"> *@

@*                         <button class="btn btn-sm btn-light position-absolute bottom-0 end-0 border rounded-circle shadow-sm" title="Đổi ảnh"> *@
@*                             <i class="bi bi-camera-fill text-muted"></i> *@
@*                         </button> *@
@*                     </div> *@

@*                     <h5 class="fw-bold mb-1">@Model.TenDangNhap</h5> *@
@*                     <p class="text-muted small mb-3">Học viên T&C Academy</p> *@

@*                     <div class="d-flex justify-content-center gap-2 mb-4"> *@
@*                         <div class="badge bg-warning text-dark px-3 py-2 rounded-pill"> *@
@*                             <i class="bi bi-coin me-1"></i> @Model.TichDiem điểm *@
@*                         </div> *@
@*                         <div class="badge bg-light text-secondary border px-3 py-2 rounded-pill"> *@
@*                             <i class="bi bi-clock-history me-1"></i> Tham gia: @(Model.NgayTao?.ToString("dd/MM/yyyy") ?? "N/A") *@
@*                         </div> *@
@*                     </div> *@
@*                 </div> *@

@*                 <div class="list-group list-group-flush"> *@
@*                     <a href="/Account/Profile" class="list-group-item list-group-item-action active border-0 py-3"> *@
@*                         <i class="bi bi-person-circle me-3"></i>Thông tin tài khoản *@
@*                     </a> *@
@*                     <a href="/KhoaHoc/MyCourses" class="list-group-item list-group-item-action border-0 py-3"> *@
@*                         <i class="bi bi-journal-bookmark-fill me-3"></i>Khóa học của tôi *@
@*                     </a> *@
@*                     <a href="/Account/MyCertificates" class="list-group-item list-group-item-action border-0 py-3"> *@
@*                         <i class="bi bi-journal-bookmark-fill me-3"></i>Chứng nhận của tôi *@
@*                     </a> *@
@*                     <a href="/GioHang/XemGioHang" class="list-group-item list-group-item-action border-0 py-3"> *@
@*                         <i class="bi bi-cart3 me-3"></i>Giỏ hàng *@
@*                     </a> *@
@*                     <a href="/Account/ChangePassword" class="list-group-item list-group-item-action border-0 py-3"> *@
@*                         <i class="bi bi-shield-lock me-3"></i>Đổi mật khẩu *@
@*                     </a> *@
@*                     <a href="/Account/Logout" class="list-group-item list-group-item-action text-danger border-0 py-3 fw-bold"> *@
@*                         <i class="bi bi-box-arrow-right me-3"></i>Đăng xuất *@
@*                     </a> *@
@*                 </div> *@
@*             </div> *@
@*         </div> *@

@*         <div class="col-lg-8"> *@
@*             <div class="card border-0 shadow-sm rounded-3"> *@
@*                 <div class="card-header bg-white py-3 border-bottom"> *@
@*                     <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-sliders me-2"></i>Cài đặt thông tin</h5> *@
@*                 </div> *@
@*                 <div class="card-body p-4"> *@
@*                     <form asp-action="UpdateProfile" method="post"> *@
@*                         <input type="hidden" asp-for="MaHV" /> *@

@*                         <div class="row g-3"> *@
@*                             <div class="col-md-6"> *@
@*                                 <label class="form-label small text-muted fw-bold">Tên đăng nhập</label> *@
@*                                 <div class="input-group"> *@
@*                                     <span class="input-group-text bg-light"><i class="bi bi-person"></i></span> *@
@*                                     <input type="text" class="form-control bg-light" value="@Model.TenDangNhap" readonly disabled> *@
@*                                 </div> *@
@*                                 <div class="form-text">Tên đăng nhập không thể thay đổi.</div> *@
@*                             </div> *@

@*                             <div class="col-md-6"> *@
@*                                 <label class="form-label small text-muted fw-bold">Ngày tham gia</label> *@
@*                                 <div class="input-group"> *@
@*                                     <span class="input-group-text bg-light"><i class="bi bi-calendar3"></i></span> *@
@*                                     <input type="text" class="form-control bg-light" value="@(Model.NgayTao?.ToString("dd/MM/yyyy HH:mm"))" readonly disabled> *@
@*                                 </div> *@
@*                             </div> *@

@*                             <div class="col-md-12"> *@
@*                                 <label asp-for="Email" class="form-label small text-muted fw-bold">Email</label> *@
@*                                 <div class="input-group"> *@
@*                                     <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span> *@
@*                                     <input asp-for="Email" class="form-control bg-light" readonly disabled> *@
@*                                 </div> *@
@*                                 <div class="form-text">Liên hệ Admin nếu bạn cần thay đổi Email.</div> *@
@*                             </div> *@

@*                             <div class="col-md-12"> *@
@*                                 <label asp-for="SoDienThoai" class="form-label small text-muted fw-bold">Số điện thoại</label> *@
@*                                 <div class="input-group"> *@
@*                                     <span class="input-group-text"><i class="bi bi-telephone"></i></span> *@
@*                                     <input asp-for="SoDienThoai" class="form-control" placeholder="Nhập số điện thoại..."> *@
@*                                 </div> *@
@*                             </div> *@

@*                         </div> *@

@*                         <div class="mt-4 d-flex justify-content-end"> *@
@*                             <button type="submit" class="btn btn-primary px-4 fw-bold"> *@
@*                                 <i class="bi bi-save me-1"></i> Lưu thay đổi *@
@*                             </button> *@
@*                         </div> *@
@*                     </form> *@
@*                 </div> *@
@*             </div> *@

@*             <div class="row mt-4"> *@
@*                 <div class="col-md-6"> *@
@*                     <div class="card border-0 shadow-sm p-3 bg-primary text-white h-100"> *@
@*                         <div class="d-flex justify-content-between align-items-center"> *@
@*                             <div> *@
@*                                 <h6 class="mb-1">Điểm tích lũy</h6> *@
@*                                 <h3 class="mb-0 fw-bold">@Model.TichDiem</h3> *@
@*                             </div> *@
@*                             <i class="bi bi-trophy fs-1 opacity-50"></i> *@
@*                         </div> *@
@*                     </div> *@
@*                 </div> *@
@*                 <div class="col-md-6"> *@
@*                     <div class="card border-0 shadow-sm p-3 bg-success text-white h-100"> *@
@*                         <div class="d-flex justify-content-between align-items-center"> *@
@*                             <div> *@
@*                                 <h6 class="mb-1">Trạng thái</h6> *@
@*                                 <h5 class="mb-0 fw-bold">Thành viên chính thức</h5> *@
@*                             </div> *@
@*                             <i class="bi bi-patch-check fs-1 opacity-50"></i> *@
@*                         </div> *@
@*                     </div> *@
@*                 </div> *@
@*             </div> *@

@*         </div> *@
@*     </div> *@
@* </div> *@

@model QL_KhoaHoc.Models.HocVien
@{
    ViewData["Title"] = "Hồ sơ cá nhân";
    Layout = "~/Views/Shared/_HocVien_Layout.cshtml";
}

<div class="container py-5">

    @* --- PHẦN THÔNG BÁO LỖI/THÀNH CÔNG --- *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
                <div class="card-body text-center bg-white p-4">
                    <div class="position-relative d-inline-block mb-3">
                        <img src="@(string.IsNullOrEmpty(Model.AnhDaiDien) ? "https://via.placeholder.com/150" : Model.AnhDaiDien)"
                             alt="Avatar"
                             id="imgAvatarPreview"
                             class="rounded-circle img-thumbnail shadow-sm"
                             style="width: 140px; height: 140px; object-fit: cover;">

                        <button type="button" class="btn btn-sm btn-light position-absolute bottom-0 end-0 border rounded-circle shadow-sm"
                                title="Đổi ảnh" onclick="document.getElementById('fileInputAvatar').click()">
                            <i class="bi bi-camera-fill text-muted"></i>
                        </button>

                        <input type="file" id="fileInputAvatar" style="display: none;" accept="image/*" onchange="uploadAvatar(this)">
                    </div>

                    <h5 class="fw-bold mb-1">@Model.TenDangNhap</h5>
                    <p class="text-muted small mb-3">Học viên T&C Academy</p>

                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <div class="badge bg-warning text-dark px-3 py-2 rounded-pill">
                            <i class="bi bi-coin me-1"></i> @Model.TichDiem điểm
                        </div>
                        <div class="badge bg-light text-secondary border px-3 py-2 rounded-pill">
                            <i class="bi bi-clock-history me-1"></i> Tham gia: @(Model.NgayTao?.ToString("dd/MM/yyyy") ?? "N/A")
                        </div>
                    </div>
                </div>

                <div class="list-group list-group-flush">
                    <a href="/Account/Profile" class="list-group-item list-group-item-action active border-0 py-3">
                        <i class="bi bi-person-circle me-3"></i>Thông tin tài khoản
                    </a>
                    <a href="/KhoaHoc/MyCourses" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="bi bi-journal-bookmark-fill me-3"></i>Khóa học của tôi
                    </a>
                    <a href="/Account/MyCertificates" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="bi bi-journal-bookmark-fill me-3"></i>Chứng nhận của tôi
                    </a>
                    <a href="/GioHang/XemGioHang" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="bi bi-cart3 me-3"></i>Giỏ hàng
                    </a>
                    <a href="/Account/ChangePassword" class="list-group-item list-group-item-action border-0 py-3">
                        <i class="bi bi-shield-lock me-3"></i>Đổi mật khẩu
                    </a>
                    <a href="/Account/Logout" class="list-group-item list-group-item-action text-danger border-0 py-3 fw-bold">
                        <i class="bi bi-box-arrow-right me-3"></i>Đăng xuất
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-sliders me-2"></i>Cài đặt thông tin</h5>
                </div>
                <div class="card-body p-4">
                    <form asp-action="UpdateProfile" method="post" id="profileForm">
                        <input type="hidden" asp-for="MaHV" />

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Tên đăng nhập</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control bg-light" value="@Model.TenDangNhap" readonly disabled>
                                </div>
                                <div class="form-text">Tên đăng nhập không thể thay đổi.</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold">Ngày tham gia</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="bi bi-calendar3"></i></span>
                                    <input type="text" class="form-control bg-light" value="@(Model.NgayTao?.ToString("dd/MM/yyyy HH:mm"))" readonly disabled>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label asp-for="Email" class="form-label small text-muted fw-bold">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-envelope"></i></span>

                                    <input asp-for="Email" class="form-control" type="email" id="txtEmail"
                                           data-original="@Model.Email" oninput="checkEmailChange()" required>

                                    <button type="button" class="btn btn-warning fw-bold" id="btnSendOTP" style="display:none;" onclick="sendOtp()">
                                        <i class="bi bi-send-fill"></i> Gửi OTP
                                    </button>
                                </div>
                                <div class="form-text text-warning">
                                    <i class="bi bi-info-circle"></i> Nếu bạn thay đổi Email, hệ thống sẽ yêu cầu xác thực OTP.
                                </div>
                            </div>

                            <div class="col-md-12" id="otpSection" style="display:none;">
                                <div class="alert alert-warning border-warning">
                                    <label class="form-label small fw-bold text-dark">Nhập mã xác thực (OTP)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-warning text-dark"><i class="bi bi-key-fill"></i></span>
                                        <input type="text" name="otpInput" class="form-control border-warning" placeholder="Nhập mã 6 số đã gửi về email mới...">
                                    </div>
                                    <small class="text-muted">Mã OTP có hiệu lực trong 5 phút.</small>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label asp-for="SoDienThoai" class="form-label small text-muted fw-bold">Số điện thoại</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                    <input asp-for="SoDienThoai" class="form-control" placeholder="Nhập số điện thoại...">
                                </div>
                            </div>

                        </div>

                        <div class="mt-4 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary px-4 fw-bold">
                                <i class="bi bi-save me-1"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm p-3 bg-primary text-white h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Điểm tích lũy</h6>
                                <h3 class="mb-0 fw-bold">@Model.TichDiem</h3>
                            </div>
                            <i class="bi bi-trophy fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm p-3 bg-success text-white h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Trạng thái</h6>
                                <h5 class="mb-0 fw-bold">Thành viên chính thức</h5>
                            </div>
                            <i class="bi bi-patch-check fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function checkEmailChange() {
        var emailInput = document.getElementById('txtEmail');
        var originalEmail = emailInput.getAttribute('data-original');
        var btnSendOTP = document.getElementById('btnSendOTP');
        var otpSection = document.getElementById('otpSection');

        // Nếu email khác email gốc và có định dạng email -> Hiện nút Gửi OTP
        if (emailInput.value !== originalEmail && emailInput.value.includes('@@')) {
            btnSendOTP.style.display = 'block';
        } else {
            btnSendOTP.style.display = 'none';
            otpSection.style.display = 'none'; // Ẩn ô OTP nếu quay về mail cũ
        }
    }

    function sendOtp() {
        var newEmail = document.getElementById('txtEmail').value;
        var btn = document.getElementById('btnSendOTP');

        // Hiệu ứng Loading
        var originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang gửi...';
        btn.disabled = true;

        $.ajax({
            url: '/HocVien/SendOtpForEmailChange', // Gọi Action Web
            type: 'POST',
            data: { newEmail: newEmail },
            success: function (res) {
                if (res.success) {
                    alert('✅ ' + res.message);
                    document.getElementById('otpSection').style.display = 'block'; // Hiện ô nhập OTP
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Đã gửi';
                    // Không enable lại nút gửi để tránh spam
                } else {
                    alert('❌ ' + res.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },
            error: function () {
                alert('Lỗi kết nối server.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    }
</script>


<script>
    function uploadAvatar(input) {
        if (input.files && input.files[0]) {
            var formData = new FormData();
            formData.append("fileAvatar", input.files[0]);

            // Hiệu ứng loading (Mờ ảnh đi)
            var imgPreview = document.getElementById('imgAvatarPreview');
            imgPreview.style.opacity = '0.5';

            $.ajax({
                url: '/HocVien/UploadAvatar',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (res) {
                    if (res.success) {
                        // Cập nhật ảnh mới ngay lập tức
                        imgPreview.src = res.imageUrl;
                        imgPreview.style.opacity = '1';
                        alert('✅ ' + res.message);

                        // (Tùy chọn) Reload trang để cập nhật avatar trên thanh menu
                        // location.reload();
                    } else {
                        alert('❌ ' + res.message);
                        imgPreview.style.opacity = '1';
                    }
                },
                error: function () {
                    alert('Lỗi kết nối server.');
                    imgPreview.style.opacity = '1';
                }
            });
        }
    }
</script>