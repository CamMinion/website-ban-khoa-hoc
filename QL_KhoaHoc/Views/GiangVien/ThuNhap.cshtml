@model List<QL_KhoaHoc.Models.ThongKeThuNhapGV>
@{
    ViewData["Title"] = "Thống kê thu nhập";
    Layout = "~/Views/Shared/_GiangVien_Layout.cshtml";

    double tongThuNhap = Model != null ? Model.Sum(x => x.DoanhThuGiangVien) : 0;
}

<div class="container-fluid py-4">

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Từ ngày</label>
                    <input type="date" name="fromDate" class="form-control" value="@(ViewBag.FromDate != null ? ((DateTime)ViewBag.FromDate).ToString("yyyy-MM-dd") : "")">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Đến ngày</label>
                    <input type="date" name="toDate" class="form-control" value="@(ViewBag.ToDate != null ? ((DateTime)ViewBag.ToDate).ToString("yyyy-MM-dd") : "")">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i> Lọc dữ liệu</button>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <a href="?fromDate=@DateTime.Now.ToString("yyyy-MM-01")&toDate=@DateTime.Now.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary flex-fill">Tháng này</a>
                    <a href="?fromDate=@(new DateTime(DateTime.Now.Year, 1, 1).ToString("yyyy-MM-dd"))&toDate=@DateTime.Now.ToString("yyyy-MM-dd")" class="btn btn-outline-secondary flex-fill">Năm nay</a>
                    <a href="/GiangVien/ThuNhap" class="btn btn-outline-danger" title="Xóa lọc"><i class="fas fa-undo"></i></a>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <h4 class="fw-bold text-secondary">
                @if (ViewBag.FromDate != null)
                {
                    <span><i class="fas fa-calendar-alt me-2"></i>Kết quả từ @(((DateTime)ViewBag.FromDate).ToString("dd/MM/yyyy")) đến @(((DateTime?)ViewBag.ToDate)?.ToString("dd/MM/yyyy") ?? "nay")</span>
                }
                else
                {
                    <span><i class="fas fa-globe me-2"></i>Doanh thu toàn thời gian</span>
                }
            </h4>
            <p class="text-muted small mb-0">Doanh thu được tính dựa trên 60% giá trị đơn hàng thực tế (theo đơn giá gốc).</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="card bg-success text-white shadow-sm h-100">
                <div class="card-body p-3 d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase mb-1 opacity-75" style="font-size: 0.8rem;">Tổng thu nhập thực nhận</h6>
                    <h3 class="fw-bold mb-0">@tongThuNhap.ToString("#,##0") đ</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-bottom-0">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-list me-2"></i>Chi tiết theo khóa học</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4 py-3">Khóa học</th>
                                    <th class="text-center py-3">Số lượng bán</th>
                                    <th class="text-end py-3">Đơn giá</th>
                                    <th class="text-end py-3">Tổng doanh thu</th>
                                    <th class="text-end pe-4 py-3 text-success">Thu nhập (60%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    foreach (var item in Model)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold text-dark text-truncate" style="max-width: 250px;" title="@item.TenKhoaHoc">
                                                @item.TenKhoaHoc
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark border">@item.SoLuongBan</span>
                                            </td>
                                            <td class="text-end text-muted small">@item.DonGiaGoc.ToString("#,##0")</td>
                                            <td class="text-end fw-semibold">@item.TongDoanhThuHeThong.ToString("#,##0")</td>
                                            <td class="text-end pe-4 fw-bold text-success">@item.DoanhThuGiangVien.ToString("#,##0")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <i class="fas fa-inbox fa-2x mb-3 d-block opacity-25"></i>
                                            Chưa có dữ liệu doanh thu trong khoảng thời gian này.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-bottom-0">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Tỷ trọng doanh thu</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 300px;">
                    @if (Model != null && Model.Any() && tongThuNhap > 0)
                    {
                        <div style="width: 100%; height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-pie fa-3x mb-3 opacity-25"></i>
                            <p>Chưa đủ dữ liệu để vẽ biểu đồ.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

@if (Model != null && Model.Any() && tongThuNhap > 0)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Chuẩn bị dữ liệu cho biểu đồ
            var labels = @Html.Raw(Json.Serialize(Model.Select(x => x.TenKhoaHoc.Length > 20 ? x.TenKhoaHoc.Substring(0, 20) + "..." : x.TenKhoaHoc)));
            var dataIncome = @Html.Raw(Json.Serialize(Model.Select(x => x.DoanhThuGiangVien)));

            var ctx = document.getElementById('revenueChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Thu nhập (VNĐ)',
                        data: dataIncome,
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                            '#858796', '#5a5c69', '#2c9faf', '#fd7e14', '#20c997'
                        ],
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20,
                                font: { size: 11, family: "'Nunito', sans-serif" }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 20
                    }
                }
            });
        });
    </script>
}